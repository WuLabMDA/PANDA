---
title: "PanDA application to cancer cell line data"
author: "Muhammad Aminu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: yes
package: PANDA
vignette: |
  %\VignetteIndexEntry{Pan-omics Discriminant Analysis with PanDA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE, 
  warning = FALSE,
  message = FALSE
)
```

```{r setup, message=FALSE, warning=FALSE}
library(Seurat)
library(Signac)
library(ggplot2)
library(cowplot)
library(caret)
library(ggpubr)
library(corrplot)
library(EnsDb.Hsapiens.v79)
library(MASS)
library(Rtsne)
library(umap)
library(pheatmap)
library(RGCCA)
library(ConsensusClusterPlus)
library(mclust)
library(aricode)
library(PANDA)
library(RColorBrewer)
```


# Introduction


# Load data

For this demo we will use a synthetic dataset simulating a scRNA-seq and scATAC-seq experimentts, generated using [MOSim](https://https://github.com/ConesaLab/MOSim).

```{r}
data("data_CancerCellLine")

rna <- data_CancerCellLine[["rna"]]
atac <- data_CancerCellLine[["atac"]]
metaData <- data_CancerCellLine[["metadata"]]
```

# Create SingleCellExperiment object
```{r, message=FALSE, warning=FALSE}
cellLine.rna <- CreateSeuratObject(counts = rna,
                                project = "cellLine",
                                assay = "RNA",
                                meta.data = metaData)

cellLine.atac <- CreateSeuratObject(counts = atac,
                                 project = "cellLine",
                                 assay = "ATAC",
                                 meta.data = metaData)
```




```{r, message=FALSE, warning=FALSE}
data <- list(rna = as.matrix(rna), atac = as.matrix(atac))
gnd <- as.numeric(as.factor(cellLine.rna@meta.data[["orig.ident"]]))
numComponents <- 100

PanDAModel <- PanDA(data,gnd,numComponents,0.005)

PanDARNA <- CreateDimReducObject(
  embeddings = PanDAModel[["PanDAComponents"]][["rnaComponents"]],
  loadings = PanDAModel[["projMatrices"]][["Wrna"]],
  stdev = numeric(),
  key = "DC_",
  assay = "RNA"
)

cellLine.rna@reductions[["PanDA"]] <- PanDARNA

cellLine.rna <- RunUMAP(cellLine.rna, dims = 1:100, reduction = "PanDA", reduction.name = "PanDAumap", reduction.key = "PandaUMAP_")
cellLine.rna <- RunTSNE(cellLine.rna, dims = 1:100, reduction = "PanDA", reduction.name = "PanDAtsne", reduction.key = "PandaTSNE_")

PanDAATAC <- CreateDimReducObject(
  embeddings = PanDAModel[["PanDAComponents"]][["atacComponents"]],
  loadings = PanDAModel[["projMatrices"]][["Watac"]],
  stdev = numeric(),
  key = "DC_",
  assay = "ATAC"
)

cellLine.atac@reductions[["PanDA"]] <- PanDAATAC

cellLine.atac <- RunUMAP(cellLine.atac, dims = 1:100, reduction = "PanDA", reduction.name = "PanDAumap", reduction.key = "PandaUMAP_")
cellLine.atac <- RunTSNE(cellLine.atac, dims = 1:100, reduction = "PanDA", reduction.name = "PanDAtsne", reduction.key = "PandaTSNE_")
```

```{r}
cols <- c("#E58601","#4E9F50","#027B8E")
p1 <- DimPlot(cellLine.rna, reduction = "PanDAumap", group.by = "orig.ident", label = FALSE, pt.size = 2, cols = cols) + NoLegend() + ggtitle("RNA")
p2 <- DimPlot(cellLine.atac, reduction = "PanDAumap", group.by = "orig.ident", label = FALSE, pt.size = 2, cols = cols) + ggtitle("ATAC")
p1 / p2
```

```{r}
FeaturePlot(object = cellLine.rna, reduction = "PanDAumap", features = c('DC_1','DC_2'), pt.size = 2)&
  scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu"))) # consider DC_1, DC_2, DC_5, DC_8
```

```{r}
FeaturePlot(object = cellLine.atac, reduction = "PanDAumap", features = c('DC_1','DC_2'), pt.size = 2)&
  scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu")))
```

```{r}
# Check correlation among extracted components
refData <- PanDAModel[["PanDAComponents"]][["rnaComponents"]]
M = cor(refData[,c(1:10)])

# corrplot(M)
corrplot.mixed(M)
```

```{r}
# Plot gene loading for PanDA components (RNA)
refComponents <- c("DC_1","DC_2")
nfea <- 30
loadingsRNA <- as.data.frame(cellLine.rna@reductions[["PanDA"]]@feature.loadings[,refComponents])
rownames(loadingsRNA) <- rownames(rna)
tempfeaRNA <- data.frame(matrix(ncol = length(refComponents), nrow = nfea))
colnames(tempfeaRNA) <- refComponents

genes <- data.frame(matrix(ncol = length(refComponents), nrow = nfea))
colnames(genes) <- refComponents

signRNA <- data.frame(matrix(ncol = length(refComponents), nrow = nfea))
colnames(signRNA) <- refComponents

for (i in 1:length(refComponents)) {
  ind <- sort(abs(loadingsRNA[,i]), decreasing = TRUE, index.return=TRUE)$ix
  tempfeaRNA[,i] <- loadingsRNA[ind[c(1:nfea)],i]
  genes[,i] <- rownames(loadingsRNA)[ind[c(1:nfea)]]
  for (j in 1:nrow(tempfeaRNA)){
    if(tempfeaRNA[j,i] > 0){
      signRNA[j,i] <- "+"
    }
    else{
      signRNA[j,i] <- "-"
    }
  }
}

# Plot the genes with top weights on component 1
ffeaRNA <- data.frame(matrix(ncol = 3, nrow = nfea))
component <- "DC_1"
ffeaRNA[,1] <- genes[,component]
ffeaRNA[,2] <- abs(tempfeaRNA[,component])
ffeaRNA[,3] <- signRNA[,component]
colnames(ffeaRNA) <- c("genes","weights","sign")

geneIDS <- ensembldb::select(EnsDb.Hsapiens.v79, keys= ffeaRNA[,1], keytype = "GENEID", columns = c("SYMBOL","GENEID"))
ffeaRNA$renamedGenes <- geneIDS$SYMBOL

ggdotchart(ffeaRNA, x = "renamedGenes", y = "weights",
           palette = cols,
           sorting = "descending",
           add = "segments",
           add.params = list(color = "#999999", size = 4),
           rotate = TRUE,
           dot.size = 8,
           label = ffeaRNA$sign,
           font.label = list(face = "bold", color = "white", size = 18, 
                             vjust = 0.4), 
           ggtheme = theme_pubr()
)+
  font("x.text", size = 18, color = "black", face = "bold.italic")+
  font("y.text", size = 18, color = "black", face = "bold.italic")+
  font("xy", size = 18, color = "black", face = "bold.italic")

```

```{r}
# plot heatmap with the top genes on component 1
nredRNA <- rna[genes[,component],]
namesredRNA <- rownames(nredRNA)

geneID2 <- ensembldb::select(EnsDb.Hsapiens.v79, keys= namesredRNA, keytype = "GENEID", columns = c("SYMBOL","GENEID"))
rownames(nredRNA) <- geneID2$SYMBOL

# out <- pheatmap(scale(nredRNA), cluster_rows=T, show_rownames=F, cutree_rows = 3, cutree_cols = 2)
outRNA <- pheatmap(t(nredRNA), cluster_rows=T, scale="row", show_rownames=F, cutree_rows = 3, cutree_cols = 2)

# Add row and column annotations
rnalabel <- cutree(outRNA$tree_row, k=3)[outRNA$tree_row[["order"]]]
annot_rna <- data.frame(row.names = names(rnalabel),
                        Clusters = as.factor(rnalabel),
                        Groundtruth = as.factor(metaData[outRNA[["tree_row"]][["order"]],"celltype"]))

my_colour = list(
  Groundtruth = c(HCT = "#E58601", Hela = "#4E9F50", K562 = "#027B8E"),
  clustering = c("1" = "#CD0BBC", "2" = "#F5C710", "3" = "#28E2E5"))

pheatmap(t(nredRNA), cluster_rows = T, cluster_cols = T,
         show_rownames = F, main = "RNA",
         scale = "row", show_colnames = T, 
         cutree_rows = 3, annotation_row = annot_rna,
         annotation_colors = my_colour)

```

```{r}
rnaclustres <- clustComp(annot_rna$Cluster, factor(annot_rna$Groundtruth))
cat(" ARI =", rnaclustres[["ARI"]],"\n", "NMI =", rnaclustres[["NMI"]])
```



<details>
  <summary>**Session Info**</summary>
  
```{r}
sessionInfo()
```

</details>
